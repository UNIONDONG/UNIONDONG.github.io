<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="【一文秒懂】Ftrace系统调试工具使用终极指南 #  1、Ftrace是什么 #  Ftrace是Function Trace的简写，由 Steven Rostedt 开发的，从 2008 年发布的内核 2.6.27 中开始就内置了。
Ftrace是一个系统内部提供的追踪工具，旨在帮助内核设计和开发人员去追踪系统内部的函数调用流程。
随着Ftrace的不断完善，除了追踪函数调用流程外，还可以用来调试和分析系统的延迟和性能问题，并发展成为一个追踪类调试工具的框架。
除了Ftrace外，追踪类调试工具还包括：
2、Ftrace的实现原理 #  为了帮助我们更好的使用Ftrace，我们有必要简单了解Ftrace的实现原理。
2.1 Ftrace框架图 #  Ftrace的框架图如下：
由框架图我们可以知道：
 ftrace包括多种类型的tracers，每个tracer完成不同的功能 将这些不同类型的tracers注册进入ftrace framework 各类tracers收集不同的信息，并放入到Ring buffer缓冲区以供调用。   2.2 Ftrace是如何记录信息的 #  Ftrace采用了静态插桩和动态插桩两种方式来实现。
静态插桩：
我们在Kernel中打开了CONFIG_FUNCTION_TRACER功能后，会增加一个-pg的一个编译选项，这个编译选项的作用就是为每个函数入口处，都会插入bl mcount跳转指令，使得每个函数运行时都会进入mcount函数。
 Ftrace一旦使能，对kernel中所有的函数插桩，这带来的性能开销是惊人的，有可能导致人们弃用Ftrace功能。
 为了解决这个问题，开发者推出了Dynamic ftrace，以此来优化整体的性能。
动态插桩：
 这里的动态，是指的动态修改函数指令。
  编译时，记录所有被添加跳转指令的函数，这里表示所有支持追踪的函数。 内核将所有跳转指令替换为nop指令，以实现非调试状态性能零损失。 根据 function tracer 设置，动态将被调试函数的nop指令，替换为跳转指令，以实现追踪。   总而言之，Ftrace记录数据可以总结为以下几个步骤：
 打开编译选项-pg，为每个函数都增加跳转指令 记录这些可追踪的函数，并为了减少性能消耗，将跳转函数替换为nop指令 通过flag标志位来动态管理，将需要追踪的函数预留的nop指令替换回追踪指令，记录调试信息。   3、如何使用Ftrace #  3.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="【一文秒懂】Ftrace系统调试工具使用终极指南" />
<meta property="og:description" content="【一文秒懂】Ftrace系统调试工具使用终极指南 #  1、Ftrace是什么 #  Ftrace是Function Trace的简写，由 Steven Rostedt 开发的，从 2008 年发布的内核 2.6.27 中开始就内置了。
Ftrace是一个系统内部提供的追踪工具，旨在帮助内核设计和开发人员去追踪系统内部的函数调用流程。
随着Ftrace的不断完善，除了追踪函数调用流程外，还可以用来调试和分析系统的延迟和性能问题，并发展成为一个追踪类调试工具的框架。
除了Ftrace外，追踪类调试工具还包括：
2、Ftrace的实现原理 #  为了帮助我们更好的使用Ftrace，我们有必要简单了解Ftrace的实现原理。
2.1 Ftrace框架图 #  Ftrace的框架图如下：
由框架图我们可以知道：
 ftrace包括多种类型的tracers，每个tracer完成不同的功能 将这些不同类型的tracers注册进入ftrace framework 各类tracers收集不同的信息，并放入到Ring buffer缓冲区以供调用。   2.2 Ftrace是如何记录信息的 #  Ftrace采用了静态插桩和动态插桩两种方式来实现。
静态插桩：
我们在Kernel中打开了CONFIG_FUNCTION_TRACER功能后，会增加一个-pg的一个编译选项，这个编译选项的作用就是为每个函数入口处，都会插入bl mcount跳转指令，使得每个函数运行时都会进入mcount函数。
 Ftrace一旦使能，对kernel中所有的函数插桩，这带来的性能开销是惊人的，有可能导致人们弃用Ftrace功能。
 为了解决这个问题，开发者推出了Dynamic ftrace，以此来优化整体的性能。
动态插桩：
 这里的动态，是指的动态修改函数指令。
  编译时，记录所有被添加跳转指令的函数，这里表示所有支持追踪的函数。 内核将所有跳转指令替换为nop指令，以实现非调试状态性能零损失。 根据 function tracer 设置，动态将被调试函数的nop指令，替换为跳转指令，以实现追踪。   总而言之，Ftrace记录数据可以总结为以下几个步骤：
 打开编译选项-pg，为每个函数都增加跳转指令 记录这些可追踪的函数，并为了减少性能消耗，将跳转函数替换为nop指令 通过flag标志位来动态管理，将需要追踪的函数预留的nop指令替换回追踪指令，记录调试信息。   3、如何使用Ftrace #  3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://uniondong.github.io/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82ftrace%E7%B3%BB%E7%BB%9F%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2023-12-13T21:56:32+08:00" />
<meta property="article:modified_time" content="2023-12-13T21:56:32+08:00" />

<title>【一文秒懂】Ftrace系统调试工具使用终极指南 | Donge Blog</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" >
<link rel="stylesheet" href="/book.min.b4905ed755e1c0335b3e405fbf0366df4ad2fc56a3731c6ad87e843b20296de1.css" integrity="sha256-tJBe11XhwDNbPkBfvwNm30rS/Fajcxxq2H6EOyApbeE=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.a72538c8a0bc372faa5c97cbec2f4e7236f2a92710063dfde31965b9a0bfe977.js" integrity="sha256-pyU4yKC8Ny&#43;qXJfL7C9OcjbyqScQBj394xlluaC/6Xc=" crossorigin="anonymous"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <meta name="referrer" content="no-referrer-when-downgrade"><!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/img/logo.png" alt="Logo" /><span>Donge Blog</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>







  
<ul>
  
  <li>
    <a href="https://blog.csdn.net/dong__ge"  target="_blank" rel="noopener">
        CSDN
      </a>
  </li>
  
  <li>
    <a href="https://www.zhihu.com/people/Embedded_Art"  target="_blank" rel="noopener">
        知乎
      </a>
  </li>
  
  <li>
    <a href="https://github.com/UNIONDONG"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>







  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>嵌入式</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3ebd3b438738bd5ab63f55999004f0e7" class="toggle"  />
    <label for="section-3ebd3b438738bd5ab63f55999004f0e7" class="flex justify-between">
      <a role="button" class="">嵌入式工程师养成记</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/embeded_tech/self_improve/10w&#43;%E9%98%85%E8%AF%BB%E8%80%97%E6%97%B6%E4%B8%80%E5%91%A8%E6%80%BB%E7%BB%93%E7%9A%84%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF%E8%B6%85%E8%AF%A6%E7%BB%86/" class="">【10W&#43;阅读】耗时一周总结的嵌入式学习路线，超详细</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-979254fc07de711332325335a96d33d1" class="toggle"  />
    <label for="section-979254fc07de711332325335a96d33d1" class="flex justify-between">
      <a role="button" class="">嵌入式面经</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/embeded_tech/embeded_interview/soc%E7%9A%84bringup%E6%B5%81%E7%A8%8B/" class="">Soc的Bring Up流程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/embeded_tech/embeded_interview/cpu%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/" class="">CPU体系架构</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/embeded_tech/embeded_interview/linux%E7%94%A8%E6%88%B7%E6%80%81%E5%92%8C%E5%86%85%E6%A0%B8%E6%80%81%E4%BA%A4%E4%BA%92%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/" class="">Linux用户态和内核态交互的几种方式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Uboot开发</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/uboot/%E4%B8%80uboot%E5%9F%BA%E7%A1%80%E4%BA%86%E8%A7%A3/" class="">一、uboot基础了解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/uboot/%E4%BA%8Cuboot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" class="">二、uboot启动流程分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/uboot/%E4%B8%89uboot%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B/" class="">三、Uboot驱动模型</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/uboot/%E5%9B%9Buboot%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%A8%A1%E5%BC%8F%E5%88%86%E6%9E%90/" class="">四、Uboot命令行模式分析</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Linux开发</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-00ea238a2f9544b32c1424d14ac8d5b7" class="toggle"  />
    <label for="section-00ea238a2f9544b32c1424d14ac8d5b7" class="flex justify-between">
      <a role="button" class="">Linux 驱动开发基础</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_driver_develop_basic/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" class="">【一文秒懂】Linux字符设备驱动</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_driver_develop_basic/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E8%AE%BE%E5%A4%87%E6%A0%91%E8%AF%A6%E8%A7%A3/" class="">【一文秒懂】Linux设备树详解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_driver_develop_basic/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82%E4%B8%BA%E4%BB%80%E4%B9%88linux%E5%86%85%E6%A0%B8%E4%B8%AD%E4%B8%8D%E7%BB%8F%E5%B8%B8%E4%BD%BF%E7%94%A8typedef/" class="">【一文秒懂】为什么Linux内核中不经常使用typedef</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3eeeb8a1a5c1ce449ec7070209d774d9" class="toggle"  />
    <label for="section-3eeeb8a1a5c1ce449ec7070209d774d9" class="flex justify-between">
      <a role="button" class="">Linux API 揭秘</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_api/linux-api-%E6%8F%AD%E7%A7%98module_init%E4%B8%8Emodule_exit/" class="">【Linux API 揭秘】module_init与module_exit</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_api/linux-api-%E6%8F%AD%E7%A7%98container_of%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3/" class="">【Linux API 揭秘】container_of函数详解</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-cad08b32e77ccfb31b07972873519838" class="toggle" checked />
    <label for="section-cad08b32e77ccfb31b07972873519838" class="flex justify-between">
      <a role="button" class="">Linux 调试工具</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7devmem/" class="">【一文秒懂】Linux内核调试工具——devmem</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82ftrace%E7%B3%BB%E7%BB%9F%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97/" class="active">【一文秒懂】Ftrace系统调试工具使用终极指南</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82top%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/" class="">【一文秒懂】TOP命令详解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7debugfs/" class="">【一文秒懂】Linux内核调试工具——Debugfs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7iperf/" class="">【一文秒懂】Linux网络性能测试工具——Iperf</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7gdb%E4%BB%8B%E7%BB%8D/" class="">【一文秒懂】Linux调试工具——GDB介绍</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7gdbserver/" class="">【一文秒懂】Linux远程调试工具——gdbserver</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E5%86%85%E6%A0%B8%E6%AD%BB%E9%94%81%E6%A3%80%E6%B5%8B/" class="">【一文秒懂】Linux内核死锁检测</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90core-dump%E6%96%87%E4%BB%B6/" class="">【一文秒懂】如何生成core Dump文件</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E4%B9%8Bcore-dump%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/" class="">【一文秒懂】Linux之Core Dump文件详解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_debug/%E4%B8%80%E6%96%87%E7%A7%92%E6%87%82linux%E5%86%85%E6%A0%B8%E6%80%81%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E6%A3%80%E6%B5%8B%E5%B7%A5%E5%85%B7/" class="">【一文秒懂】Linux内核态内存泄露检测工具</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b3bfa0c2506d9fd89a39b0698e122f31" class="toggle"  />
    <label for="section-b3bfa0c2506d9fd89a39b0698e122f31" class="flex justify-between">
      <a role="button" class="">Linux 内存管理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_memory_manage/%E4%B8%80%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%9A%84%E7%94%B1%E6%9D%A5%E5%8F%8A%E6%80%9D%E6%83%B3/" class="">一、内存管理的由来及思想</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_memory_manage/%E4%BA%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%B8%83%E5%B1%80/" class="">二、虚拟地址空间布局</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_memory_manage/%E4%B8%89%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86/" class="">三、虚拟地址空间管理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_memory_manage/%E5%9B%9B%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%9E%8B/" class="">四、物理地址空间设计模型</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_memory_manage/%E4%BA%94%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4%E5%B8%83%E5%B1%80%E5%8F%8A%E7%AE%A1%E7%90%86/" class="">五、物理内存空间布局及管理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_memory_manage/%E5%85%AD%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%BC%99%E4%BC%B4%E7%B3%BB%E7%BB%9F/" class="">六、物理内存分配——伙伴系统</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2455edf5b3ea22c6053a61d28029cb9a" class="toggle"  />
    <label for="section-2455edf5b3ea22c6053a61d28029cb9a" class="flex justify-between">
      <a role="button" class="">Linux 内核锁详解</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_kernel_lock/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E9%94%81%E6%9C%BA%E5%88%B6%E4%B8%80%E5%86%85%E6%A0%B8%E9%94%81%E7%9A%84%E7%94%B1%E6%9D%A5/" class="">【深入理解Linux锁机制】一、内核锁的由来</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_kernel_lock/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E9%94%81%E6%9C%BA%E5%88%B6%E4%BA%8C%E4%B8%AD%E6%96%AD%E5%B1%8F%E8%94%BD/" class="">【深入理解Linux锁机制】二、中断屏蔽</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_kernel_lock/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E9%94%81%E6%9C%BA%E5%88%B6%E4%B8%89%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/" class="">【深入理解Linux锁机制】三、原子操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_kernel_lock/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E9%94%81%E6%9C%BA%E5%88%B6%E5%9B%9B%E8%87%AA%E6%97%8B%E9%94%81/" class="">【深入理解Linux锁机制】四、自旋锁</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_kernel_lock/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E9%94%81%E6%9C%BA%E5%88%B6%E4%BA%94%E8%A1%8D%E7%94%9F%E8%87%AA%E6%97%8B%E9%94%81/" class="">【深入理解Linux锁机制】五、衍生自旋锁</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_kernel_lock/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E9%94%81%E6%9C%BA%E5%88%B6%E5%85%AD%E4%BF%A1%E5%8F%B7%E9%87%8F/" class="">【深入理解Linux锁机制】六、信号量</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_kernel_lock/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E9%94%81%E6%9C%BA%E5%88%B6%E4%B8%83%E4%BA%92%E6%96%A5%E4%BD%93/" class="">【深入理解Linux锁机制】七、互斥体</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_kernel_lock/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E9%94%81%E6%9C%BA%E5%88%B6%E5%85%AB%E5%AE%8C%E6%88%90%E9%87%8F/" class="">【深入理解Linux锁机制】八、完成量</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3e346f9c1e7b71569b8cd088121d9787" class="toggle"  />
    <label for="section-3e346f9c1e7b71569b8cd088121d9787" class="flex justify-between">
      <a role="button" class="">Linux NVMEM 子系统</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_nvmem_subsystem/nvmem%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E4%B8%80efuse%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8%E6%B5%85%E6%9E%90/" class="">【NVMEM子系统深入剖析】一、Efuse介绍及安全启动浅析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_nvmem_subsystem/nvmem%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E4%BA%8Cnvmem%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6/" class="">【NVMEM子系统深入剖析】二、NVMEM驱动框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_nvmem_subsystem/nvmem%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E4%B8%89%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E5%86%85%E5%9C%A8%E5%85%B3%E8%81%94/" class="">【NVMEM子系统深入剖析】三、核心数据结构及内在关联</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_nvmem_subsystem/nvmem%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90%E5%9B%9Befuse%E9%A9%B1%E5%8A%A8%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B/" class="">【NVMEM子系统深入剖析】四、efuse驱动实现流程</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9ae83851c5fe25a6d227e96b400b1ab9" class="toggle"  />
    <label for="section-9ae83851c5fe25a6d227e96b400b1ab9" class="flex justify-between">
      <a role="button" class="">Linux LED子系统</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E4%B8%80linux%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E6%96%B0%E6%89%8B%E5%BF%85%E8%AF%BB/" class="">【LED子系统深度剖析】一、开篇词|Linux驱动开发新手必读</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E4%BA%8Cled%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/" class="">【LED子系统深度剖析】二、LED子系统框架分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E4%B8%89%E7%A1%AC%E4%BB%B6%E9%A9%B1%E5%8A%A8%E5%B1%82%E8%AF%A6%E8%A7%A3/" class="">【LED子系统深度剖析】三、硬件驱动层详解</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E5%9B%9B%E6%A0%B8%E5%BF%83%E5%B1%82%E8%AF%A6%E8%A7%A3%E4%B8%80/" class="">【LED子系统深度剖析】四、核心层详解（一）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E4%BA%94%E6%A0%B8%E5%BF%83%E5%B1%82%E8%AF%A6%E8%A7%A3%E4%BA%8C/" class="">【LED子系统深度剖析】五、核心层详解（二）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E5%85%AD%E6%A0%B8%E5%BF%83%E5%B1%82%E8%AF%A6%E8%A7%A3%E4%B8%89/" class="">【LED子系统深度剖析】六、核心层详解（三）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E4%B8%83%E8%A7%A6%E5%8F%91%E5%99%A8%E5%AE%9E%E7%8E%B0/" class="">【LED子系统深度剖析】七、触发器实现</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E5%85%AB%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80/" class="">【LED子系统深度剖析】八、小试牛刀</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E4%B9%9D%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3%E7%95%AA%E5%A4%96%E7%AF%87/" class="">【LED子系统深度剖析】九、数据结构详解（番外篇）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_led_subsystem/led%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%B7%B1%E5%BA%A6%E5%89%96%E6%9E%90%E5%8D%81%E8%AF%A6%E7%BB%86%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B%E7%95%AA%E5%A4%96%E7%AF%87/" class="">【LED子系统深度剖析】十、详细实现流程（番外篇）</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-bf0229851221605a75715f5f9633256a" class="toggle"  />
    <label for="section-bf0229851221605a75715f5f9633256a" class="flex justify-between">
      <a role="button" class="">Linux MMC 子系统</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_mmc_subsystem/mmc%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%B8%80mmc_sd_sdio%E4%BB%8B%E7%BB%8D/" class="">【MMC子系统】一、MMC_SD_SDIO介绍</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_mmc_subsystem/mmc%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%BA%8Cemmc%E5%8D%8F%E8%AE%AE/" class="">【MMC子系统】二、EMMC协议</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_mmc_subsystem/mmc%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%B8%89mmc%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6/" class="">【MMC子系统】三、MMC子系统框架</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_mmc_subsystem/mmc%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%9B%9Bmmc%E6%8E%A7%E5%88%B6%E5%99%A8%E9%A9%B1%E5%8A%A8%E5%B1%82/" class="">【MMC子系统】四、MMC控制器驱动层</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_mmc_subsystem/mmc%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%BA%94mmc%E6%A0%B8%E5%BF%83%E5%B1%82/" class="">【MMC子系统】五、MMC核心层</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/linux_mmc_subsystem/mmc%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%85%ADmmc%E5%9D%97%E8%AE%BE%E5%A4%87%E5%B1%82/" class="">【MMC子系统】六、MMC块设备层</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-541874a152001b263009202c99a285c4" class="toggle"  />
    <label for="section-541874a152001b263009202c99a285c4" class="flex justify-between">
      <a role="button" class="">Bluetooth蓝牙开发详解</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E4%B8%80%E6%89%93%E9%80%A0%E5%85%A8%E7%BD%91%E6%9C%80%E8%AF%A6%E7%BB%86%E7%9A%84bluetooth%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/" class="">【Bluetooth蓝牙开发】一、打造全网最详细的Bluetooth开发教程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E4%BA%8C%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/" class="">【Bluetooth蓝牙开发】二、蓝牙开发入门</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E4%B8%89%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%80%BB%E8%A7%88%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE/" class="">【Bluetooth蓝牙开发】三、一篇文章，带你总览蓝牙协议</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E5%9B%9Bble%E5%8D%8F%E8%AE%AE%E4%B9%8B%E7%89%A9%E7%90%86%E5%B1%82%E6%B5%85%E6%9E%90/" class="">【Bluetooth蓝牙开发】四、BLE协议之物理层浅析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E4%BA%94ble%E5%8D%8F%E8%AE%AE%E4%B9%8B%E9%93%BE%E8%B7%AF%E5%B1%82/" class="">【Bluetooth蓝牙开发】五、BLE协议之链路层</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E5%85%ADble%E5%8D%8F%E8%AE%AE%E4%B9%8B%E4%BC%A0%E8%BE%93%E5%B1%82/" class="">【Bluetooth蓝牙开发】六、BLE协议之传输层</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E4%B8%83ble%E5%8D%8F%E8%AE%AE%E4%B9%8Bl2cap/" class="">【Bluetooth蓝牙开发】七、BLE协议之L2CAP</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E5%85%ABble%E5%8D%8F%E8%AE%AE%E4%B9%8Batt/" class="">【Bluetooth蓝牙开发】八、BLE协议之ATT</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E4%B9%9Dble%E5%8D%8F%E8%AE%AEgatt/" class="">【Bluetooth蓝牙开发】九、BLE协议——GATT</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E5%8D%81ble%E8%93%9D%E7%89%99%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E5%B9%BF%E6%92%AD%E6%89%AB%E6%8F%8F%E6%96%AD%E5%BC%80%E8%BF%9E%E6%8E%A5/" class="">【Bluetooth蓝牙开发】十、BLE蓝牙通信流程（建立连接，广播，扫描，断开连接）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E5%8D%81%E4%B8%80%E8%B6%85%E8%AF%A6%E7%BB%86%E7%9A%84bluez%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/" class="">【Bluetooth蓝牙开发】十一、超详细的Bluez交叉编译</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/bluetooth/bluetooth%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91%E5%8D%81%E4%BA%8C%E8%93%9D%E7%89%99%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7%E9%9B%86%E5%90%88%E6%B1%87%E6%80%BB/" class="">【Bluetooth蓝牙开发】十二、蓝牙调试工具【集合汇总】</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3962d06d522e4ac6aca7d70bdb913d71" class="toggle"  />
    <label for="section-3962d06d522e4ac6aca7d70bdb913d71" class="flex justify-between">
      <a role="button" class="">WiFi开发详解</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/wifi/wifi%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/" class="">WIFI基础知识汇总</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/wifi/%E4%B8%80%E6%96%87%E8%AF%A6%E8%A7%A3%E8%B7%AF%E7%94%B1%E5%99%A8%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF/" class="">一文详解路由器配置信息</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux/wifi/wifi%E6%97%A0%E7%BC%9D%E6%BC%AB%E6%B8%B8%E8%AF%A6%E8%A7%A3/" class="">WiFi无缝漫游详解</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>【一文秒懂】Ftrace系统调试工具使用终极指南</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <!DOCTYPE html>
<html>
<body>
  <div class="card">
    <img class="image" src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/dxh.jpg" alt="donge">
    <div class="card-info">
      <span>Donge</span>
      <p style="font-size: 13px;">专注高质量嵌入式知识分享</p>
    </div>
    <a href="https://t.zsxq.com/14hPUwE8z" class="button">Folow</a>
  </div>
</body>
</html>



<nav id="TableOfContents">
  <ul>
    <li><a href="#一文秒懂ftrace系统调试工具使用终极指南">【一文秒懂】Ftrace系统调试工具使用终极指南</a>
      <ul>
        <li><a href="#1ftrace是什么">1、Ftrace是什么</a></li>
        <li><a href="#2ftrace的实现原理">2、Ftrace的实现原理</a>
          <ul>
            <li><a href="#21-ftrace框架图">2.1 Ftrace框架图</a></li>
            <li><a href="#22-ftrace是如何记录信息的">2.2 Ftrace是如何记录信息的</a></li>
          </ul>
        </li>
        <li><a href="#3如何使用ftrace">3、如何使用Ftrace</a>
          <ul>
            <li><a href="#31-配置详解">3.1 配置详解</a></li>
            <li><a href="#32-挂载debugfs文件系统">3.2 挂载debugfs文件系统</a></li>
            <li><a href="#33-traceing目录介绍">3.3 traceing目录介绍</a></li>
            <li><a href="#34-简单使用示例">3.4 简单使用示例</a></li>
          </ul>
        </li>
        <li><a href="#4进阶用法">4、进阶用法</a>
          <ul>
            <li><a href="#41-追踪任意命令">4.1 追踪任意命令</a></li>
            <li><a href="#42-追踪指定函数的调用流程">4.2 追踪指定函数的调用流程</a></li>
            <li><a href="#43-追踪指定模块的所有函数">4.3 追踪指定模块的所有函数</a></li>
          </ul>
        </li>
        <li><a href="#5自动化管理">5、自动化管理</a></li>
        <li><a href="#6总结">6、总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
<!DOCTYPE html>
<html>
<body>
    <div class="card-toc-after">
        <img class="drainage-image-toc-after" src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/image-20240120185454193.png" alt="img"/>
        <div class="bg-toc-after">
        </div>
        <div class="blob-toc-after"></div>
      </div>
</body>
</html>


  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="一文秒懂ftrace系统调试工具使用终极指南">
  【一文秒懂】Ftrace系统调试工具使用终极指南
  <a class="anchor" href="#%e4%b8%80%e6%96%87%e7%a7%92%e6%87%82ftrace%e7%b3%bb%e7%bb%9f%e8%b0%83%e8%af%95%e5%b7%a5%e5%85%b7%e4%bd%bf%e7%94%a8%e7%bb%88%e6%9e%81%e6%8c%87%e5%8d%97">#</a>
</h1>
<h2 id="1ftrace是什么">
  1、Ftrace是什么
  <a class="anchor" href="#1ftrace%e6%98%af%e4%bb%80%e4%b9%88">#</a>
</h2>
<p><code>Ftrace</code>是<code>Function Trace</code>的简写，由 <code>Steven Rostedt</code> 开发的，从 2008 年发布的内核 2.6.27 中开始就内置了。</p>
<p><code>Ftrace</code>是一个系统内部提供的追踪工具，旨在帮助内核设计和开发人员去追踪系统内部的函数调用流程。</p>
<p>随着<code>Ftrace</code>的不断完善，除了追踪函数调用流程外，还可以用来调试和分析系统的延迟和性能问题，并发展成为一个追踪类调试工具的框架。</p>
<p>除了<code>Ftrace</code>外，追踪类调试工具还包括：</p>
<p><img src="https://tinylab.org/wp-content/uploads/2016/10//tracing.jpg" alt="Tracing overview" /></p>
<h2 id="2ftrace的实现原理">
  2、Ftrace的实现原理
  <a class="anchor" href="#2ftrace%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86">#</a>
</h2>
<p>为了帮助我们更好的使用<code>Ftrace</code>，我们有必要简单了解<code>Ftrace</code>的实现原理。</p>
<h3 id="21-ftrace框架图">
  2.1 Ftrace框架图
  <a class="anchor" href="#21-ftrace%e6%a1%86%e6%9e%b6%e5%9b%be">#</a>
</h3>
<p><code>Ftrace</code>的框架图如下：</p>
<p><img src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/eb77832145c246c99848330e16448451.png" alt="在这里插入图片描述" /></p>
<p>由框架图我们可以知道：</p>
<ul>
<li><code>ftrace</code>包括多种类型的<code>tracers</code>，每个<code>tracer</code>完成不同的功能</li>
<li>将这些不同类型的<code>tracers</code>注册进入<code>ftrace framework</code></li>
<li>各类<code>tracers</code>收集不同的信息，并放入到<code>Ring buffer</code>缓冲区以供调用。</li>
</ul>
<p> </p>
<h3 id="22-ftrace是如何记录信息的">
  2.2 Ftrace是如何记录信息的
  <a class="anchor" href="#22-ftrace%e6%98%af%e5%a6%82%e4%bd%95%e8%ae%b0%e5%bd%95%e4%bf%a1%e6%81%af%e7%9a%84">#</a>
</h3>
<p><code>Ftrace</code>采用了静态插桩和动态插桩两种方式来实现。</p>
<p><strong>静态插桩</strong>：</p>
<p>我们在<code>Kernel</code>中打开了<code>CONFIG_FUNCTION_TRACER</code>功能后，会增加一个<code>-pg</code>的一个编译选项，这个编译选项的作用就是为每个函数入口处，都会插入<code>bl mcount</code>跳转指令，使得每个函数运行时都会进入<code>mcount</code>函数。</p>
<blockquote>
<p><code>Ftrace</code>一旦使能，对<code>kernel</code>中所有的函数插桩，这带来的性能开销是惊人的，有可能导致人们弃用<code>Ftrace</code>功能。</p>
</blockquote>
<p>为了解决这个问题，开发者推出了<code>Dynamic ftrace</code>，以此来优化整体的性能。</p>
<p><strong>动态插桩</strong>：</p>
<blockquote>
<p>这里的动态，是指的动态修改函数指令。</p>
</blockquote>
<ol>
<li>编译时，记录所有被添加跳转指令的函数，这里表示所有支持追踪的函数。</li>
<li>内核将所有跳转指令替换为<code>nop</code>指令，以实现非调试状态性能零损失。</li>
<li>根据 <code>function tracer</code> 设置，动态将被调试函数的<code>nop</code>指令，替换为跳转指令，以实现追踪。</li>
</ol>
<p> </p>
<p><strong>总而言之，<code>Ftrace</code>记录数据可以总结为以下几个步骤</strong>：</p>
<ol>
<li>打开编译选项<code>-pg</code>，为每个函数都增加跳转指令</li>
<li>记录这些可追踪的函数，并为了减少性能消耗，将跳转函数替换为<code>nop</code>指令</li>
<li>通过<code>flag</code>标志位来动态管理，将需要追踪的函数预留的<code>nop</code>指令替换回追踪指令，记录调试信息。</li>
</ol>
<p> </p>
<h2 id="3如何使用ftrace">
  3、如何使用Ftrace
  <a class="anchor" href="#3%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8ftrace">#</a>
</h2>
<h3 id="31-配置详解">
  3.1 配置详解
  <a class="anchor" href="#31-%e9%85%8d%e7%bd%ae%e8%af%a6%e8%a7%a3">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#8be9fd;font-style:italic">CONFIG_FTRACE</span><span style="color:#ff79c6">=</span>y 							<span style="color:#6272a4"># 启用了 Ftrace</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_FUNCTION_TRACER</span><span style="color:#ff79c6">=</span>y					<span style="color:#6272a4"># 启用函数级别的追踪器</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_HAVE_FUNCTION_GRAPH_TRACER</span><span style="color:#ff79c6">=</span>y			<span style="color:#6272a4"># 表示内核支持图形显示</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_FUNCTION_GRAPH_TRACER</span><span style="color:#ff79c6">=</span>y				<span style="color:#6272a4"># 以图形的方式显示函数追踪过程</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_STACK_TRACER</span><span style="color:#ff79c6">=</span>y						<span style="color:#6272a4"># 启用堆栈追踪器，用于跟踪内核函数调用的堆栈信息。</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_DYNAMIC_FTRACE</span><span style="color:#ff79c6">=</span>y						<span style="color:#6272a4"># 启用动态 Ftrace，允许在运行时启用和禁用 Ftrace 功能。</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_HAVE_FTRACE_NMI_ENTER</span><span style="color:#ff79c6">=</span>y				<span style="color:#6272a4"># 表示内核支持非屏蔽中断（NMI）时进入 Ftrace 的功能</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_HAVE_FTRACE_MCOUNT_RECORD</span><span style="color:#ff79c6">=</span>y			<span style="color:#6272a4"># 表示内核支持通过 mcount 记录函数调用关系。</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_FTRACE_NMI_ENTER</span><span style="color:#ff79c6">=</span>y                   <span style="color:#6272a4"># 表示内核支持通过 mcount 记录函数调用关系。   </span>
<span style="color:#8be9fd;font-style:italic">CONFIG_FTRACE_SYSCALLS</span><span style="color:#ff79c6">=</span>y					<span style="color:#6272a4"># 系统调用的追踪</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_FTRACE_MCOUNT_RECORD</span><span style="color:#ff79c6">=</span>y				<span style="color:#6272a4"># 启用 mcount 记录函数调用关系。</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_SCHED_TRACER</span><span style="color:#ff79c6">=</span>y						<span style="color:#6272a4"># 支持调度追踪</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_FUNCTION_PROFILER</span><span style="color:#ff79c6">=</span>y					<span style="color:#6272a4"># 启用函数分析器，主要用于记录函数的执行时间和调用次数</span>
<span style="color:#8be9fd;font-style:italic">CONFIG_DEBUG_FS</span><span style="color:#ff79c6">=</span>y							<span style="color:#6272a4"># 启用 Debug 文件系统支持</span>
</code></pre></div><blockquote>
<p>上面只是介绍了部分配置，更多详细配置可自行了解。</p>
<p>并且上述配置不一定全部打开，勾选自己需要的即可，通常我们选择<code>CONFIG_FUNCTION_TRACER</code>和<code>CONFIG_HAVE_FUNCTION_GRAPH_TRACER</code>即可，然后编译烧录到开发板。</p>
</blockquote>
<p> </p>
<h3 id="32-挂载debugfs文件系统">
  3.2 挂载debugfs文件系统
  <a class="anchor" href="#32-%e6%8c%82%e8%bd%bddebugfs%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f">#</a>
</h3>
<p><code>Ftrace</code>是基于<code>debugfs</code>调试文件系统的，所以我们的第一步就是先挂载<code>debugfs</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mount -t debugfs none /sys/kernel/debug
</code></pre></div><p>此时我们能够在<code>/sys/kernel/debug</code>下看到内核支持的所有的调试信息了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># cd /sys/kernel/debug/</span>
<span style="color:#6272a4"># ls</span>
asoc                gpio                regmap
bdi                 ieee80211           sched_debug
block               memblock            sched_features
clk                 mmc0                sleep_time
device_component    mmc1                suspend_stats
devices_deferred    mtd                 tracing
dma_buf             opp                 ubi
extfrag             pinctrl             ubifs
fault_around_bytes  pm_qos              wakeup_sources
</code></pre></div><p> </p>
<h3 id="33-traceing目录介绍">
  3.3 traceing目录介绍
  <a class="anchor" href="#33-traceing%e7%9b%ae%e5%bd%95%e4%bb%8b%e7%bb%8d">#</a>
</h3>
<p>在<code>/sys/kernel/debug</code>目录下，包含的是<code>kernel</code>所有的调试信息，本章只关注与<code>tracing</code>目录，下面挑选一些比较重要的属性文件来分析。</p>
<p> </p>
<blockquote>
<p>万变不离其宗，如此复杂的框架，设计人员已经提供了<code>README</code>文件，里面详解了各个属性文件的含义，我建议抛弃本文，看<code>README</code>吧:)</p>
</blockquote>
<h4 id="331-trace">
  3.3.1 trace
  <a class="anchor" href="#331-trace">#</a>
</h4>
<p><code>trace</code> ：包含当前追踪的内容，以人类可读的格式展现，通过<code>echo &gt; trace</code>来清除。</p>
<p> </p>
<h4 id="332-trace_pipe">
  3.3.2 trace_pipe
  <a class="anchor" href="#332-trace_pipe">#</a>
</h4>
<p><code>trace_pipe</code> 和 <code>trace</code> 一样，都是记录当前的追踪内容，但它和 <code>trace</code> 不一样的是：</p>
<ul>
<li>对 <code>trace_pipe</code> 的读操作将会阻塞，直到有新的追踪数据进来为止；</li>
<li>当前从<code>trace_pipe</code> 读取的内容将被消耗掉，再次读 <code>trace_pipe</code> 又会阻塞到新数据进来为止。</li>
</ul>
<blockquote>
<p>简单的来说，<code>cat trace_pipe</code>是堵塞读取，有数据就读，没数据就等待；而<code>cat trace</code>有没有数据都是直接返回的</p>
</blockquote>
<p> </p>
<h4 id="333-tracing_on">
  3.3.3 tracing_on
  <a class="anchor" href="#333-tracing_on">#</a>
</h4>
<p><code>tracing_on</code>：向 <code>tracing_on</code> 写入 1，启用追踪；向 <code>tracing_on</code> 写入 0，停止追踪。</p>
<blockquote>
<p>追踪使用 <code>ring buffer</code> 记录追踪数据。修改 <code>tracing_on</code> 不会影响 <code>ring buffer</code> 当前记录的内容。</p>
</blockquote>
<p> </p>
<h4 id="334-current_tracer">
  3.3.4 current_tracer
  <a class="anchor" href="#334-current_tracer">#</a>
</h4>
<p><code>current_tracer</code> 表示当前启用的 tracer ，默认为 <code>nop</code> ，即不做任何追踪工作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># cat current_tracer</span>
nop
</code></pre></div><p> </p>
<h4 id="335-available_filter_functions">
  3.3.5 available_filter_functions
  <a class="anchor" href="#335-available_filter_functions">#</a>
</h4>
<p><code>available_filter_functions</code>：可以被追踪的函数列表，即可以写到 <code>set_ftrace_filter，set_ftrace_notrace，set_graph_function，set_graph_notrace</code> 文件的函数列表。</p>
<p> </p>
<h4 id="336-available_tracers">
  3.3.6 available_tracers
  <a class="anchor" href="#336-available_tracers">#</a>
</h4>
<p><code>available_tracers</code> 文件中包含的是当前编译到内核的 tracer 列表，也表示当前内核支持的<code>tracer</code>列表。</p>
<p>该列表的内容，就是可以写到 <code>current_tracer</code> 的 <code>tracer</code> 名。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># cat available_tracers</span>
function_graph <span style="color:#ff79c6">function</span> nop
</code></pre></div><ul>
<li><code>nop</code>：表示为空，不追踪</li>
<li><code>function</code>：追踪函数调用</li>
<li><code>function_graph</code>：以图形形式追踪函数调用</li>
</ul>
<p> </p>
<h4 id="337-buffer_size_kb">
  3.3.7 buffer_size_kb
  <a class="anchor" href="#337-buffer_size_kb">#</a>
</h4>
<p><code>buffer_size_kb</code> 记录 <code>CPU buffer</code> 的大小，单位为 <code>KB</code> 。</p>
<p><code>per_cpu/cpuX/buffer_size_kb</code> 记录 <code>每个CPU buffer</code> 大小，单位为 <code>KB</code> 。可通过写 <code>buffer_size_kb</code> 来改变 <code>CPU buffer</code> 的大小。</p>
<p> </p>
<h4 id="338-buffer_total_size_kb">
  3.3.8 buffer_total_size_kb
  <a class="anchor" href="#338-buffer_total_size_kb">#</a>
</h4>
<p><code>buffer_total_size_kb</code> 记录所有 <code>CPU buffer</code> 的总大小，即所有 CPU buffer 大小总和。</p>
<blockquote>
<p>如有 128 个 CPU buffer ，每个大小 7KB，则 <code>buffer_total_size_kb</code> 记录的总大小为 128 * 7KB = 896。</p>
</blockquote>
<p><code>buffer_total_size_kb</code> 文件是只读的。</p>
<p> </p>
<h4 id="339-set_ftrace_filter">
  3.3.9 set_ftrace_filter
  <a class="anchor" href="#339-set_ftrace_filter">#</a>
</h4>
<p><code>set_ftrace_filter</code> ：过滤函数追踪，仅仅追踪写入该文件的函数名。</p>
<p>可填入的参数，可以通过<code>available_filter_functions</code>文件查看当前支持的函数名。</p>
<p>该过滤功能，也有很多其他变体，如追踪某个模块的函数调用等。</p>
<blockquote>
<p>官方给的示例：</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Format: :mod:&lt;module-name&gt;
example: <span style="color:#8be9fd;font-style:italic">echo</span> :mod:ext3 &gt; set_ftrace_filter		<span style="color:#6272a4"># 该模块必须是已经加载进去的模块</span>
</code></pre></div><p> </p>
<h4 id="3310-set_ftrace_notrace">
  3.3.10 set_ftrace_notrace
  <a class="anchor" href="#3310-set_ftrace_notrace">#</a>
</h4>
<p><code>set_ftrace_notrace</code>：和 <code>set_ftrace_filter</code> 刚好相反，系统禁用对其中列举函数的追踪。</p>
<p> </p>
<h4 id="3311-set_ftrace_pid">
  3.3.11 set_ftrace_pid
  <a class="anchor" href="#3311-set_ftrace_pid">#</a>
</h4>
<p>系统对 <code>set_ftrace_pid</code> 文件中指定的 <code>PID</code>进程进行追踪。</p>
<p>如果开启了 <code>options/function-fork</code> 选项，<code>fork</code> 的子进程的 <code>PID</code> 也会自动加入文件，同时该选项也会引起系统自动将退出进程的 <code>PID</code> 从文件中移除。</p>
<p> </p>
<h4 id="3312-set_graph_function">
  3.3.12 set_graph_function
  <a class="anchor" href="#3312-set_graph_function">#</a>
</h4>
<p>此文件中列出的函数将导致<strong>函数图跟踪器仅跟踪这些函数以及它们调用的函数</strong>。</p>
<p>但是该跟踪的记录，仍然受<code>set_ftrace_filter</code> 和 <code>set_ftrace_notrace</code> 的影响。</p>
<p> </p>
<h4 id="3312-set_graph_notrace">
  3.3.12 set_graph_notrace
  <a class="anchor" href="#3312-set_graph_notrace">#</a>
</h4>
<p>与 <code>set_graph_function</code> 类似，但当函数被命中时，将禁用函数图跟踪，直到退出函数。</p>
<p> </p>
<h3 id="34-简单使用示例">
  3.4 简单使用示例
  <a class="anchor" href="#34-%e7%ae%80%e5%8d%95%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b">#</a>
</h3>
<blockquote>
<p>一般我们挂载上<code>debugfs</code>后，<code>tracing_on</code>是处于打开状态的。</p>
</blockquote>
<h4 id="341-函数追踪">
  3.4.1 函数追踪
  <a class="anchor" href="#341-%e5%87%bd%e6%95%b0%e8%bf%bd%e8%b8%aa">#</a>
</h4>
<p><img src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/image-20240110110558815.png" alt="image-20240110110558815" /></p>
<p> </p>
<h4 id="342-追踪图形显示">
  3.4.2 追踪图形显示
  <a class="anchor" href="#342-%e8%bf%bd%e8%b8%aa%e5%9b%be%e5%bd%a2%e6%98%be%e7%a4%ba">#</a>
</h4>
<p><img src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/image-20240110110617669.png" alt="image-20240110110617669" /></p>
<p> </p>
<h4 id="343-动态过滤追踪">
  3.4.3 动态过滤追踪
  <a class="anchor" href="#343-%e5%8a%a8%e6%80%81%e8%bf%87%e6%bb%a4%e8%bf%bd%e8%b8%aa">#</a>
</h4>
<p><img src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/image-20240110110641149.png" alt="image-20240110110641149" /></p>
<p> </p>
<h4 id="344-重置追踪">
  3.4.4 重置追踪
  <a class="anchor" href="#344-%e9%87%8d%e7%bd%ae%e8%bf%bd%e8%b8%aa">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#bd93f9">0</span> &gt; tracing_on			<span style="color:#6272a4"># 关闭trace</span>
<span style="color:#8be9fd;font-style:italic">echo</span> &gt; trace				<span style="color:#6272a4"># 清空当前trace记录</span>
cat available_tracers 		<span style="color:#6272a4"># 查看当前支持的追踪类型</span>
<span style="color:#8be9fd;font-style:italic">echo</span> function_graph &gt; current_tracer 	<span style="color:#6272a4"># 设置当前的追踪类型</span>
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#bd93f9">1</span> &gt; tracing_on			<span style="color:#6272a4"># 开启追踪</span>
cat trace					<span style="color:#6272a4"># 查看追踪结果</span>
</code></pre></div><p> </p>
<h2 id="4进阶用法">
  4、进阶用法
  <a class="anchor" href="#4%e8%bf%9b%e9%98%b6%e7%94%a8%e6%b3%95">#</a>
</h2>
<p>上述章节，只是介绍了<code>Ftrace</code>最基本的命令，下面来看一下<code>Ftrace</code>在具体问题中的用法！</p>
<h3 id="41-追踪任意命令">
  4.1 追踪任意命令
  <a class="anchor" href="#41-%e8%bf%bd%e8%b8%aa%e4%bb%bb%e6%84%8f%e5%91%bd%e4%bb%a4">#</a>
</h3>
<blockquote>
<p>如何追踪我们执行的命令呢？</p>
</blockquote>
<p><code>Ftrace</code>支持追踪特定进程，通过<code>set_ftrace_pid</code>属性来设置指定进程。然后在该进程中，执行特定的命令。</p>
<p>首先我们需要设置好我们的追踪器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mount -t debugfs none /sys/kernel/debug
<span style="color:#8be9fd;font-style:italic">cd</span> /sys/kernel/debug/tracing
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#bd93f9">0</span> &gt; tracing_on									<span style="color:#6272a4"># 关闭追踪器</span>
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#ff79c6">function</span> &gt; current_tracer						<span style="color:#6272a4"># 设置当前追踪类别</span>

</code></pre></div><p>在我们设置好追踪器后，使用如下命令，即可追踪我们执行的命令<code>your_command</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">echo</span> &gt; trace; <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#8be9fd;font-style:italic">$$</span> &gt; set_ftrace_pid; <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#bd93f9">1</span> &gt; tracing_on; your_command; <span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#bd93f9">0</span> &gt; tracing_on
</code></pre></div><p> </p>
<h3 id="42-追踪指定函数的调用流程">
  4.2 追踪指定函数的调用流程
  <a class="anchor" href="#42-%e8%bf%bd%e8%b8%aa%e6%8c%87%e5%ae%9a%e5%87%bd%e6%95%b0%e7%9a%84%e8%b0%83%e7%94%a8%e6%b5%81%e7%a8%8b">#</a>
</h3>
<p>跟踪函数的时候，设置 <code>echo 1 &gt; options/func_stack_trace</code> 即可在 <code>trace</code> 结果中获取追踪函数的调用栈。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mount -t debugfs none /sys/kernel/debug
<span style="color:#8be9fd;font-style:italic">cd</span> /sys/kernel/debug/tracing
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#bd93f9">0</span> &gt; tracing_on									<span style="color:#6272a4"># 关闭追踪器</span>
cat available_filter_functions | grep <span style="color:#f1fa8c">&#34;xxxxxx&#34;</span>		<span style="color:#6272a4"># 搜索函数是否存在</span>
<span style="color:#8be9fd;font-style:italic">echo</span> xxxxxx &gt; set_ftrace_filter						<span style="color:#6272a4"># 设定追踪的函数</span>
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#ff79c6">function</span> &gt; current_tracer						<span style="color:#6272a4"># 设置当前追踪类别</span>
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#bd93f9">1</span> &gt; options/func_stack_trace					<span style="color:#6272a4"># 记录堆栈信息</span>
<span style="color:#8be9fd;font-style:italic">echo</span> &gt; trace										<span style="color:#6272a4"># 清空缓存</span>
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#bd93f9">1</span> &gt; tracing_on									<span style="color:#6272a4"># 开始追踪</span>
</code></pre></div><p><strong>效果如下</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># cat trace</span>
<span style="color:#6272a4"># tracer: function</span>
<span style="color:#6272a4">#</span>
<span style="color:#6272a4"># entries-in-buffer/entries-written: 2/2   #P:3</span>
<span style="color:#6272a4">#</span>
<span style="color:#6272a4">#                              _-----=&gt; irqs-off</span>
<span style="color:#6272a4">#                             / _----=&gt; need-resched</span>
<span style="color:#6272a4">#                            | / _---=&gt; hardirq/softirq</span>
<span style="color:#6272a4">#                            || / _--=&gt; preempt-depth</span>
<span style="color:#6272a4">#                            ||| /     delay</span>
<span style="color:#6272a4">#           TASK-PID   CPU#  ||||    TIMESTAMP  FUNCTION</span>
<span style="color:#6272a4">#              | |       |   ||||       |         |</span>
     kworker/1:1-59    <span style="color:#ff79c6">[</span>001<span style="color:#ff79c6">]</span> ....   168.954199: mmc_rescan &lt;-process_one_work
     kworker/1:1-59    <span style="color:#ff79c6">[</span>001<span style="color:#ff79c6">]</span> ....   168.954248: &lt;stack trace&gt;
 <span style="color:#ff79c6">=</span>&gt; <span style="color:#8be9fd;font-style:italic">mmc_rescan</span>
 <span style="color:#ff79c6">=</span>&gt; <span style="color:#8be9fd;font-style:italic">process_one_work</span>
 <span style="color:#ff79c6">=</span>&gt; <span style="color:#8be9fd;font-style:italic">worker_thread</span>
 <span style="color:#ff79c6">=</span>&gt; <span style="color:#8be9fd;font-style:italic">kthread</span>
 <span style="color:#ff79c6">=</span>&gt; <span style="color:#8be9fd;font-style:italic">ret_from_fork</span>
 <span style="color:#ff79c6">=</span>&gt; <span style="color:#bd93f9">0</span>
</code></pre></div><p> </p>
<h3 id="43-追踪指定模块的所有函数">
  4.3 追踪指定模块的所有函数
  <a class="anchor" href="#43-%e8%bf%bd%e8%b8%aa%e6%8c%87%e5%ae%9a%e6%a8%a1%e5%9d%97%e7%9a%84%e6%89%80%e6%9c%89%e5%87%bd%e6%95%b0">#</a>
</h3>
<p>要想我们的<code>ko</code>文件能够被<code>Ftrace</code>记录到，<strong>我们需要在编译模块的时候，加上编译参数<code>-pg</code></strong>，这点很重要，否则你在<code>available_filter_functions</code>列表中，查找不到你想要的函数。</p>
<p>然后，需要我们设置过滤器，设置方法有以下几种：</p>
<ul>
<li><strong>按模块直接过滤</strong>：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># 示例</span>
Format: :mod:&lt;module-name&gt;
example: <span style="color:#8be9fd;font-style:italic">echo</span> :mod:ext3 &gt; set_ftrace_filter
</code></pre></div><blockquote>
<p>追踪<code>ext3</code>模块内的所有函数</p>
</blockquote>
<p> </p>
<ul>
<li><strong>按函数直接过滤</strong></li>
</ul>
<blockquote>
<p>如果该模块内的函数，命名都有一定的规则，可以按照正则表达式来过滤</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># 示例</span>
<span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;mmc*&#34;</span> &gt; set_ftrace_filter
</code></pre></div><blockquote>
<p>过滤包含<code>mmc</code>字符的所有函数</p>
</blockquote>
<p> </p>
<ul>
<li><strong>按照函数差异来过滤</strong></li>
</ul>
<p>如果函数命名没有规律，又想过滤该模块所有函数，该怎么办？</p>
<p>按照加载模块前后的函数差异，写入到文件中来过滤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat available_filter_functions &gt; /tmp/1.txt
cat available_filter_functions &gt; /tmp/2.txt
diff /tmp/1.txt /tmp/2.txt &gt; /tmp/3.txt
cat /tmp/3.txt | sed <span style="color:#f1fa8c">&#39;s/^+//&#39;</span> | awk <span style="color:#f1fa8c">&#39;{print $1}&#39;</span>	<span style="color:#6272a4"># 如果diff出来格式前带有+-号，需要手动去掉</span>
cat /tmp/3.txt &gt; set_ftrace_filter
</code></pre></div><p> </p>
<h2 id="5自动化管理">
  5、自动化管理
  <a class="anchor" href="#5%e8%87%aa%e5%8a%a8%e5%8c%96%e7%ae%a1%e7%90%86">#</a>
</h2>
<p><code>Ftrace</code>功能很强大，在内核层面我们通过<code>echo</code>和<code>cat</code>即可获取我们想要的所有信息，但是通过一次一次敲命令显得有些繁琐，自己也对常用的功能整合了一个自动化脚本，能够通过命令行，直接追踪特定模块、函数、命令，极大提高了调试效率。</p>
<p>自动化脚本获取路径：<a href="https://t.zsxq.com/16255aqlY">common_trace.sh</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#6272a4"># /root/common_trace.sh </span>
Usage: /root/common_trace.sh <span style="color:#ff79c6">{</span>module|funcs|funcs_stack|command|clear<span style="color:#ff79c6">}</span>
       /root/common_trace.sh module ext4 
       /root/common_trace.sh funcs sysfs 
       /root/common_trace.sh funcs_stack sysfs 
       /root/common_trace.sh <span style="color:#8be9fd;font-style:italic">command</span> sysfs <span style="color:#ff79c6">[</span>functions<span style="color:#ff79c6">]</span> 
       /root/common_trace.sh clear
</code></pre></div><p>脚本主要实现的功能有：</p>
<ul>
<li>追踪指定模块，查看所有调用流程</li>
<li>追踪指定函数，查看该函数的调用链</li>
<li>追踪指定函数，获取堆栈信息</li>
<li>追踪用户命令，查看所有调用流程，并可选择指定函数来查看调用流程。</li>
</ul>
<blockquote>
<p>脚本除了<code>command</code>功能外，其他功能都需要手动调用<code>common_trace.sh clear</code>来停止追踪。</p>
</blockquote>
<p> </p>
<h2 id="6总结">
  6、总结
  <a class="anchor" href="#6%e6%80%bb%e7%bb%93">#</a>
</h2>
<p>以上，介绍了<code>Ftrace</code>的由来，实现原理，以及如何使用<code>Ftrace</code>，并最终提供了自动化测试脚本，希望对大家有所帮助。</p>
<center><b> <font color ="blue">欢迎关注【嵌入式艺术】，董哥原创！</font></b></center>
<div align=center><img src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/blog.png" alt="img" width = "60%" height ="10%"/>
</div>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>


<div class="busuanzi-footer">
  <span id="busuanzi_container_site_pv">
    👁️Total Views <span id="busuanzi_value_site_pv"></span> |
  </span>
  <span id="busuanzi_container_site_uv" >
    👤Visitors <span id="busuanzi_value_site_uv"></span>
  </span>
</div>

  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){if(window.getSelection().toString())return;a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  <!DOCTYPE html>
<html>
<body>
  <div class="card">
    <img class="image" src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/dxh.jpg" alt="donge">
    <div class="card-info">
      <span>Donge</span>
      <p style="font-size: 13px;">专注高质量嵌入式知识分享</p>
    </div>
    <a href="https://t.zsxq.com/14hPUwE8z" class="button">Folow</a>
  </div>
</body>
</html>



<nav id="TableOfContents">
  <ul>
    <li><a href="#一文秒懂ftrace系统调试工具使用终极指南">【一文秒懂】Ftrace系统调试工具使用终极指南</a>
      <ul>
        <li><a href="#1ftrace是什么">1、Ftrace是什么</a></li>
        <li><a href="#2ftrace的实现原理">2、Ftrace的实现原理</a>
          <ul>
            <li><a href="#21-ftrace框架图">2.1 Ftrace框架图</a></li>
            <li><a href="#22-ftrace是如何记录信息的">2.2 Ftrace是如何记录信息的</a></li>
          </ul>
        </li>
        <li><a href="#3如何使用ftrace">3、如何使用Ftrace</a>
          <ul>
            <li><a href="#31-配置详解">3.1 配置详解</a></li>
            <li><a href="#32-挂载debugfs文件系统">3.2 挂载debugfs文件系统</a></li>
            <li><a href="#33-traceing目录介绍">3.3 traceing目录介绍</a></li>
            <li><a href="#34-简单使用示例">3.4 简单使用示例</a></li>
          </ul>
        </li>
        <li><a href="#4进阶用法">4、进阶用法</a>
          <ul>
            <li><a href="#41-追踪任意命令">4.1 追踪任意命令</a></li>
            <li><a href="#42-追踪指定函数的调用流程">4.2 追踪指定函数的调用流程</a></li>
            <li><a href="#43-追踪指定模块的所有函数">4.3 追踪指定模块的所有函数</a></li>
          </ul>
        </li>
        <li><a href="#5自动化管理">5、自动化管理</a></li>
        <li><a href="#6总结">6、总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
<!DOCTYPE html>
<html>
<body>
    <div class="card-toc-after">
        <img class="drainage-image-toc-after" src="https://image-1305421143.cos.ap-nanjing.myqcloud.com/image/image-20240120185454193.png" alt="img"/>
        <div class="bg-toc-after">
        </div>
        <div class="blob-toc-after"></div>
      </div>
</body>
</html>

 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












